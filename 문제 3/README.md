# 문제 3

사내에서 쓰이는 BO(Back office) 서비스를 개발하려고 합니다.

1. 로그인방식인 OAuth와 JWT 둘중에 어느것을 사용하여 개발을 하실건가요?
2. 둘중 선택한 이유와 장점에 대해 설명해주세요
3. 구현 방법을 서술해 주세요 (다이어그램등을 활용하셔서 첨부하셔도 좋습니다)

---

### 💡 추가질문 - 실제로 구현해본 경험이 있다면, 해당 구현 경험을 서술해주세요

---

### ↘️ ANSWER 1. 로그인방식인 OAuth와 JWT 둘중에 어느것을 사용하여 개발을 하실건가요?

- 사내 백오피스라면 JWT를 사용할 것 같습니다.

### ↘️ ANSWER 2. 둘중 선택한 이유와 장점에 대해 설명해주세요.

- 구현이 간단하기에 사용자 등급에 맞는 권한 커스텀 등이 자유롭습니다.
- 상세정보를 잘 모르는 고객이 아닌 내부 사용자 위주의 환경이기때문에 굳이 외부로의 위임이 불필요하다 생각됩니다.
- JWT는 서명만 검증하면 되기 때문에 외부로 위임하지 않는 만큼 속도적 측면에서 이득을 볼 수 있습니다.
- OAuth와 JWT 모두 무상태성(stateless)이 장점이지만 직급에 따른 접근권한(?) 등과 같은 일부 정보의 경우 서버 내에 남겨두어야 하는 상황이 있을 수도 있다 생각됩니다. 이럴 때 필요한 상태 정보를 서버에서 관리할 수 있다는 장점이 있습니다.

### ↘️ ANSWER 3. 구현 방법을 서술해 주세요 (다이어그램등을 활용하셔서 첨부하셔도 좋습니다)

```
+---------+                    +---------------+                    +------------+                    +---------+
| Client  |--------------------|  Auth Server  |--------------------|  Database  |--------------------|  Redis  |
+---------+                    +---------------+                    +------------+                    +---------+
     |                                 |                                  |                                |
     | ----------POST /login---------> |                                  |                                |
     |                                 | --------사용자 검증 요청-------> |                                |
     |                                 | <-------사용자 인증 확인-------- |                                |
     |                                 |                                  ┸                                |
     |                                 | ---------AT(AccessToken), RT(RefreshToken) 생성 후 저장---------> |
     | <----------AT, RT 전달--------- |                                                                   |
     |                                 |                                                                   |
     | ---------GET /자원요청--------> |                                                                   |
     | <------AT검증 후 자료제공------ |                                                                   |
     |                                 |                                                                   |
     | ---------GET /자원요청--------> |                                                                   |
     |                                 | ----------------AT만료로 RT를 통한 사용자 재인증----------------> |
     |                                 | <---------------------RT 사용자 인증 확인------------------------ |
     |                                 | ---------------------AT, RT 재발급 후 저장----------------------> |
     | <----------AT, RT 전달--------- |                                                                   |
     |                                 |                                                                   |
     | ----GET /자원요청 (반복...)---> |                                                                   |

```

#### 1. 로그인 요청 (Client -> Auth Server)

클라이언트가 사용자의 아이디, 비밀번호 등의 자격증명을 포함해 /login 엔드포인트로 로그인 요청을 보냅니다.

#### 2. 사용자 검증 (Auth Server -> Database)

인증 서버는 Database에 사용자 정보를 요청하여 자격증명을 검증합니다.

#### 3. AccessToken 및 RefreshToken 생성 (Auth Server)

사용자가 정상임을 확인하면, 인증 서버는 사용자의 정보를 포함하는 AT와 별도의 RT를 생성합니다.

#### 4. RefreshToken 저장 (Auth Server -> Redis)

생성된 RT는 Redis에 저장되어, 추후 토큰 갱신 시 해당 RT의 유효성을 빠르게 검증할 수 있습니다.

#### 5. 토큰 전달 (Auth Server -> Client)

생성되어 레디스에 저장한 토큰들을 클라이언트에 응답으로 전달합니다.

#### 6. 자원 요청 (Client -> Auth Server)

클라이언트는 AT를 포함하여 자원에 접근 요청을 보냅니다. 이 때 클라이언트는 API 호출 시 AT를 Authorization 헤더에 포함시켜 요청합니다.

#### 7. 자원 제공 (Auth Server)

서버는 토큰의 서명을 검증하고, 유효하면 요청된 자원을 제공합니다.

#### 8. 토큰 갱신 요청 (Client -> Auth Server)

AT가 만료된 경우, 클라이언트는 저장된 RT를 사용하여 특정 refresh 엔드포인트로 새로운 토큰 발행 요청을 합니다.

#### 9. 토큰 유효성 확인 (Auth Server -> Redis)

인증 서버는 Redis에서 해당 RT의 존재 및 유효성을 검증합니다.

#### 10. 새로운 토큰 발행 (Auth Server -> Client)

검증에 성공하면, 인증 서버는 새로운 AT, RT를 생성하여 Redis에 저장 및 클라이언트에게 전달합니다.

### ↘️ ANSWER 4. 추가 질문 - 실제로 구현해본 경험이 있다면, 해당 구현 경험을 서술해주세요

사용자 인증에 대한 보안에 관심이 생겨 토이 프로젝트를 진행하며 JWT토큰의 보안에 관해 깊게 고민해본 적이 있습니다.

쿠키와 유사한 방식으로 서버 세션이 아닌 클라이언트사이드에 저장되며 DB에 저장하는 해싱된 비밀번호가 아닌 단순 토큰값만 있으면 자원을 요청할 수 있는 키값이기에 어떻게 하면 보안을 강화할 수 있을까 고민하였습니다.

AccessToken이 탈취당하는 시나리오부터 시작해서 RefreshTokenRotation 기법까지 스스로 꼬리에 꼬리를 물며 특정 방법을 사용했을 때 서버에 가해지는 부담과 악성 사용자에게 노출될 위험 사이에서 최선의 타협점을 찾으려 굉장히 고민했습니다.

구현은 JWT+ Passport + AuthGuard + Redis 로 하였으며 인증이 필요한 엔드포인트의 컨트롤러에 @UseGuard로 처리하였습니다.

아래는 토이프로젝트를 제작할 당시 기록해두었던 포트폴리오 페이지와 깃허브 주소입니다.  
[ 포트폴리오 ]: https://portfolio.osj-nas.synology.me/portfolio/delivery-master  
[ 깃허브 ]: https://github.com/SeongJae-git/delivery-master
